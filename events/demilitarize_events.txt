namespace = demilitarization

country_event = {
	id = demilitarization.101
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				NOT = {	exists = event_target:demilitarization_loser }
				has_modifier = dm_demilitarizer
			}
			remove_modifier = dm_demilitarizer
		}
		else = {
			if = {
				limit = {
					is_guaranteeing = event_target:demilitarization_loser  # Valid
				}
				country_event = {
					id = demilitarization.101
					days = 30
				}
			}
			else = {
				dm_remove_loser_mod = {
					loser = event_target:demilitarization_loser
				}
				# Message
				create_message = {
					type = DIPLO_ACTION_BREAK_GUARANTEE
					localization = MESSAGE_DEMILITRAIZATION_REVOKE_GUARANTEE
					days = 30
					target = capital_scope
					variable = {
						type = name
						localization = LOSER
						scope = event_target:demilitarization_loser
					}
					variable = {
						type = name
						localization = VICTOR
						scope = root
					}
				}
			}
		}
	}
}

country_event = {
	id = demilitarization.102
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				NOT = {	exists = event_target:demilitarization_victor }
			}
			dm_remove_loser_mod = {
				loser = root
			}
		}
		else = {
			if = {
				limit = {
					event_target:demilitarization_victor = {
						is_guaranteeing = root  # Valid
					}
				}
				country_event = {
					id = demilitarization.102
					days = 30
				}
			}
		}
	}
}

# Dispatch
country_event = {
	id = demilitarization.103
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_variable = {
			which = i
			value = 0
		}
		while = {
			limit = {
				check_variable = {
					which = i
					value < 3600
				}
			}
			# log = "i = [this.i]" #TODO
			country_event = {
				id = demilitarization.200
				days = $i$
			}
			country_event = {
				id = demilitarization.201
				days = $i$
			}
			change_variable  = {
				which = i
				value = 60
			}
		}
	}
}

country_event = {
	id = demilitarization.200
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				NOR = {
					exists = event_target:demilitarization_loser
					event_target:demilitarization_victor = {
						is_guaranteeing = event_target:demilitarization_loser
					}
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_victor
				}
				event_target:demilitarization_victor = {
					remove_modifier = dm_demilitarizer
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_loser
				}
				dm_remove_loser_mod = {
					loser = event_target:demilitarization_loser
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_loser
					exists = event_target:demilitarization_victor
				}
				# Message
				create_message = {
					type = DIPLO_ACTION_BREAK_GUARANTEE
					localization = MESSAGE_DEMILITRAIZATION_REVOKE_GUARANTEE
					days = 30
					target = capital_scope
					variable = {
						type = name
						localization = VICTOR
						scope = event_target:demilitarization_victor
					}
					variable = {
						type = name
						localization = LOSER
						scope = event_target:demilitarization_loser
					}
				}
			}
		}


		# if = {
		# 	limit = {
		# 		NOR = {
		# 			exists = event_target:demilitarization_loser
		# 			is_guaranteeing = event_target:demilitarization_loser
		# 		}
		# 	}
		# 	remove_modifier = dm_demilitarizer  # FIXME multi to multi
		# }
	}
}

country_event = {
	id = demilitarization.201
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				NOR = {
					exists = event_target:demilitarization_victor
					exists = event_target:demilitarization_loser
					event_target:demilitarization_victor = {
						is_guaranteeing = event_target:demilitarization_loser
					}
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_victor
				}
				event_target:demilitarization_victor = {
					remove_modifier = dm_demilitarizer
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_loser
				}
				dm_remove_loser_mod = {
					loser = event_target:demilitarization_loser
				}
			}
			if = {
				limit = {
					exists = event_target:demilitarization_loser
					exists = event_target:demilitarization_victor
				}
				# Message
				create_message = {
					type = DIPLO_ACTION_BREAK_GUARANTEE
					localization = MESSAGE_DEMILITRAIZATION_REVOKE_GUARANTEE
					days = 30
					target = capital_scope
					variable = {
						type = name
						localization = VICTOR
						scope = event_target:demilitarization_victor
					}
					variable = {
						type = name
						localization = LOSER
						scope = event_target:demilitarization_loser
					}
				}
			}
		}
	}
}

